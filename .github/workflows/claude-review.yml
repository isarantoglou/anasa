name: Claude PR Review

on:
  # Auto-review for PRs from the same repo (not forks)
  pull_request:
    types: [opened, synchronize, reopened]
  # Manual trigger via comment for fork PRs (maintainer comments "@claude review")
  issue_comment:
    types: [created]

# Permissions required for Claude to comment on PRs
permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write

jobs:
  auto-review:
    # Run for:
    # 1. pull_request events (auto-review, but secrets only work for non-fork PRs)
    # 2. issue_comment with "@claude" on a PR (manual trigger, works for fork PRs)
    if: >
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: '--model claude-opus-4-5-20251101'
          trigger_phrase: '@claude'
          prompt: |
            Review this pull request for the Ανάσα (Anasa) Vue 3 + TypeScript project.

            IMPORTANT: First read CLAUDE.md to understand the project guidelines and conventions.

            ## Review Checklist
            Please check for:

            ### 1. Code Quality
            - [ ] Follows Vue 3 Composition API with `<script setup>`
            - [ ] TypeScript types are properly defined
            - [ ] No unused imports or variables
            - [ ] Code is readable and maintainable

            ### 2. Testing
            - [ ] Unit tests are updated for changed code
            - [ ] E2E tests are updated if UI changed
            - [ ] All existing tests should still pass

            ### 3. Security
            - [ ] No hardcoded secrets or API keys
            - [ ] No XSS vulnerabilities in templates
            - [ ] User input is properly sanitized

            ### 4. Project Standards
            - [ ] Commit message follows Conventional Commits (feat/fix/docs/test/chore)
            - [ ] Greek text/labels are spelled correctly
            - [ ] Uses date-fns with Greek locale for dates

            ### 5. Performance
            - [ ] No unnecessary re-renders
            - [ ] Large lists use virtualization if needed
            - [ ] Images are optimized

            Provide specific feedback with file paths and line numbers where possible.
            If tests need to be updated, explain exactly what selectors or assertions need to change.
